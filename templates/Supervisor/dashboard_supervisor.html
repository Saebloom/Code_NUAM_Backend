<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Supervisor - NUAM</title>
    <style>
        /* --- Estilos Globales --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        html, body { height: 100%; overflow: hidden; background-color: #f4f4f4; }
        .app-container { display: flex; flex-direction: column; height: 100vh; }

        /* Barra Superior */
        .top-bar { background-color: white; padding: 1rem 2rem; font-size: 1.5rem; font-weight: 600; color: #FD441E; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); z-index: 10; display: flex; align-items: center; gap: 0.75rem; }
        .top-bar-logo { height: 32px; width: auto; }

        /* Cuerpo */
        .dashboard-body { display: flex; flex-grow: 1; height: calc(100% - 60px); }
        .sidenav { flex-basis: 260px; flex-shrink: 0; background-color: #2c2c2c; color: white; padding: 1.5rem 1rem; display: flex; flex-direction: column; overflow-y: auto; }
        .main-content { flex-grow: 1; padding: 2rem 2.5rem; overflow-y: auto; background-color: #f4f4f4; }

        /* Perfil */
        .sidenav-profile { display: flex; flex-direction: column; align-items: center; padding-bottom: 1.5rem; border-bottom: 1px solid #555; margin-bottom: 1.5rem; }
        .sidenav-profile-pic { width: 70px; height: 70px; border-radius: 50%; background-color: #FD441E; color: white; display: grid; place-items: center; font-size: 2rem; font-weight: bold; margin-bottom: 0.75rem; }
        .sidenav-profile .username { font-weight: 600; font-size: 1.1rem; }
        .sidenav-profile .role { font-size: 0.9rem; color: #ccc; }

        /* Navegación */
        .sidenav-nav { display: flex; flex-direction: column; gap: 0.5rem; flex-grow: 1; }
        .sidenav-nav button { background: none; border: none; color: #e0e0e0; padding: 0.9rem 1.25rem; text-align: left; font-size: 1rem; cursor: pointer; border-radius: 8px; display: flex; align-items: center; gap: 0.75rem; transition: background-color 0.2s; }
        .sidenav-nav button:hover { background-color: #444; }
        .sidenav-nav button.active { background-color: #FD441E; color: white; font-weight: 600; }
        .sidenav-nav button svg { width: 1.1em; height: 1.1em; fill: currentColor; flex-shrink: 0; }

        /* Footer */
        .sidenav-footer { margin-top: auto; padding: 1rem; border-top: 1px solid #4a4a4a; }
        .logout-button { display: flex; align-items: center; width: 100%; padding: 0.85rem 1.25rem; font-size: 0.95rem; font-weight: 500; cursor: pointer; border-radius: 6px; background-color: #575757; color: #ececec; border: none; transition: background-color 0.2s; }
        .logout-button:hover { background-color: #FD441E; color: white; }

        /* Vistas y Tarjetas */
        .content-view { display: none; }
        .content-view.active { display: block; }
        .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .content-header h2 { color: #FD441E; font-size: 1.8rem; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); padding: 1.5rem; margin-bottom: 1.5rem; }

        /* Filtros y Forms */
        .filters { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; }
        .filters input, .filters select { padding: 0.75rem; border: 1px solid #ccc; border-radius: 8px; font-size: 0.95rem; min-width: 200px; }
        .form-group { display: flex; flex-direction: column; margin-bottom: 1rem; }
        .form-group label { font-weight: 600; margin-bottom: 0.5rem; color: #555; }
        .form-group input, .form-group select { padding: 0.75rem; border: 1px solid #ccc; border-radius: 8px; font-size: 0.95rem; width: 100%; }

        /* Botones */
        .btn-primary { background-color: #FD441E; color: white; border: none; padding: 0.75rem 1.25rem; border-radius: 8px; font-size: 0.95rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; }
        .btn-primary:hover { background-color: #e03c1a; }
        .btn-secondary { background-color: #6c757d; color: white; border: none; padding: 0.75rem 1.25rem; border-radius: 8px; font-size: 0.95rem; font-weight: 600; cursor: pointer; }
        .btn-primary svg { width: 1em; height: 1em; fill: currentColor; }

        /* Tabla */
        .table-container { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        thead { background-color: #f9f9f9; }
        th, td { padding: 0.9rem 0.75rem; border-bottom: 1px solid #ddd; text-align: left; white-space: nowrap; }
        th { font-weight: 600; color: #333; }

        /* Modales */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.4); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 2rem; border: 1px solid #888; border-radius: 8px; width: 90%; max-width: 500px; position: relative; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; padding-bottom: 1rem; margin-bottom: 1.5rem; }
        .modal-header h2 { color: #FD441E; }
        .modal-close { color: #aaa; font-size: 2rem; font-weight: bold; cursor: pointer; }
        .modal-footer { border-top: 1px solid #ddd; padding-top: 1.5rem; margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 1rem; }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="top-bar">
            <img src="/static/img/Nuam.png" alt="Nuam Logo" class="top-bar-logo"> nuam
        </header>

        <div class="dashboard-body">
            <nav class="sidenav">
                <div class="sidenav-profile">
                    <div class="sidenav-profile-pic" id="profile-pic">S</div>
                    <span class="username" id="profile-name">Supervisor</span>
                    <span class="role" id="profile-role">Supervisor</span>
                </div>
                
                <div class="sidenav-nav">
                    <button class="active" onclick="showView('view-consulta', this)">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z"/></svg>
                        Consulta Calificaciones
                    </button>
                    <button onclick="showView('view-reportes', this)">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M64 0C28.7 0 0 28.7 0 64V448c0 35.3 28.7 64 64 64H320c35.3 0 64-28.7 64-64V160H256c-17.7 0-32-14.3-32-32V0H64zM256 0V128H384L256 0zM216 408c0 13.3-10.7 24-24 24s-24-10.7-24-24V305.9l-31 31c-9.4 9.4-24.6 9.4-33.9 0s-9.4-24.6 0-33.9l72-72c9.4-9.4 24.6-9.4 33.9 0l72 72c9.4 9.4 9.4 24.6 0 33.9s-24.6 9.4-33.9 0l-31-31V408z"/></svg>
                        Reportes
                    </button>
                    <button onclick="showView('view-logs', this)">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M464 256A208 208 0 1 1 48 256a208 208 0 1 1 416 0zM0 256a256 256 0 1 0 512 0A256 256 0 1 0 0 256zM232 120V256c0 8 4 15.5 10.7 20l96 64c11 7.4 25.9 4.4 33.3-6.7s4.4-25.9-6.7-33.3L280 243.2V120c0-13.3-10.7-24-24-24s-24 10.7-24 24z"/></svg>
                        Historial de Operaciones
                    </button>
                </div>
                
                <div class="sidenav-footer">
                    <button class="logout-button" onclick="logout()">
                        <span class="icon">&#x21B3;</span> Cerrar Sesión
                    </button>
                </div>
            </nav>

            <main class="main-content">

                <div id="view-consulta" class="content-view active">
                    <div class="content-header">
                        <h2>Consulta de Calificaciones</h2>
                    </div>
                    <div class="card">
                        <div class="filters">
                            <input type="number" id="filter-id" placeholder="ID Calificación">
                            <input type="text" id="filter-email" placeholder="Email Corredor">
                            <input type="number" id="filter-anio" placeholder="Año (ej. 2025)">
                            <button class="btn-primary" onclick="handleSearch()">Buscar</button>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr><th>ID</th><th>Corredor</th><th>Monto</th><th>Fecha Emisión</th><th>Instrumento</th><th>Estado</th></tr>
                                </thead>
                                <tbody id="consulta-tbody"><tr><td colspan="6" style="text-align:center">Cargando...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="view-reportes" class="content-view">
                    <div class="content-header">
                        <h2>Generación de Reportes</h2>
                    </div>

                    <div class="card" style="border-left: 5px solid #fd7e14;">
                        <h3 style="margin-bottom:1rem; color:#fd7e14;">1. Reporte Consolidado (General)</h3>
                        <p style="color:#666; margin-bottom:1rem;">Genera un archivo Excel con múltiples registros aplicando filtros.</p>
                        <div style="text-align:right;">
                            <button class="btn-primary" onclick="showReportModal('consolidado')" style="background-color:#fd7e14;">
                                Configurar y Descargar
                            </button>
                        </div>
                    </div>

                    <div class="card" style="border-left: 5px solid #20c997;">
                        <h3 style="margin-bottom:1rem; color:#20c997;">2. Reporte Específico (Individual)</h3>
                        <p style="color:#666; margin-bottom:1rem;">Busca una calificación específica por ID para descargar su detalle.</p>
                        <div style="text-align:right;">
                            <button class="btn-primary" onclick="showReportModal('especifico')" style="background-color:#20c997;">
                                Configurar y Descargar
                            </button>
                        </div>
                    </div>
                </div>

                <div id="view-logs" class="content-view">
                    <div class="content-header">
                        <h2>Historial de Operaciones (Auditoría)</h2>
                    </div>
                    <div class="card">
                        <div class="table-container">
                            <table>
                                <thead><tr><th>Fecha</th><th>Acción</th><th>Usuario</th><th>Detalle</th></tr></thead>
                                <tbody id="logs-tbody"><tr><td colspan="4" style="text-align:center">Cargando...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <div id="modal-reporte-consolidado" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Reporte Consolidado</h2><span class="modal-close" onclick="closeModal('modal-reporte-consolidado')">&times;</span></div>
            <div class="modal-body">
                <form onsubmit="event.preventDefault(); generateConsolidatedReport();">
                    <div class="form-group">
                        <label>Mercado</label>
                        <select id="reporte-mercado"><option value="">Cargando...</option></select>
                    </div>
                    <div class="form-group">
                        <label>Estado</label>
                        <select id="reporte-estado"><option value="">Cargando...</option></select>
                    </div>
                    <div class="form-group">
                        <label>Usuario (Corredor)</label>
                        <select id="reporte-usuario"><option value="">Cargando...</option></select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="closeModal('modal-reporte-consolidado')">Cancelar</button>
                        <button type="submit" class="btn-primary">Descargar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="modal-reporte-especifico" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Reporte Específico</h2><span class="modal-close" onclick="closeModal('modal-reporte-especifico')">&times;</span></div>
            <div class="modal-body">
                <form onsubmit="event.preventDefault(); generateSpecificReport();">
                    <div class="form-group">
                        <label>Seleccionar Calificación</label>
                        <select id="reporte-calificacion" required><option value="">Cargando...</option></select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="closeModal('modal-reporte-especifico')">Cancelar</button>
                        <button type="submit" class="btn-primary">Descargar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "http://127.0.0.1:8000/api";
        const token = localStorage.getItem('access');

        window.onload = function() {
            if (!token) { window.location.href = '/'; return; }
            loadProfile();
            fetchConsultaCalificaciones();
            fetchLogs();
            loadReportDropdowns(); // Carga los selects de los modales
        };

        // NAVEGACIÓN
        function showView(viewId, btn) {
            document.querySelectorAll('.content-view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.sidenav-nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            if(btn) btn.classList.add('active');
        }
        function showModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function logout() { localStorage.removeItem('access'); window.location.href = '/'; }

        // DATOS
        async function loadProfile() {
            try {
                const res = await fetch(`${API_BASE}/users/me/`, { headers: { 'Authorization': `Bearer ${token}` } });
                const user = await res.json();
                document.getElementById('profile-name').textContent = user.first_name || user.username;
                document.getElementById('profile-pic').textContent = (user.first_name || 'S').charAt(0);
            } catch(e) {}
        }

        // VISTA CONSULTA
        async function fetchConsultaCalificaciones(query="") {
            const tbody = document.getElementById('consulta-tbody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">Cargando...</td></tr>';
            try {
                const res = await fetch(`${API_BASE}/calificaciones/${query}`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                const list = data.results || data;
                tbody.innerHTML = "";
                if (list.length === 0) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">No hay registros.</td></tr>';
                
                list.forEach(c => {
                    tbody.innerHTML += `<tr>
                        <td>${c.id}</td>
                        <td>${c.usuario ? (c.usuario.first_name || c.usuario.username) : 'N/A'}</td>
                        <td>${c.monto_factor}</td>
                        <td>${c.fecha_emision}</td>
                        <td>${c.instrumento ? c.instrumento.nombre : 'N/A'}</td>
                        <td>${c.estado ? c.estado.nombre : 'N/A'}</td>
                    </tr>`;
                });
            } catch(e) { tbody.innerHTML = '<tr><td colspan="6">Error.</td></tr>'; }
        }
        function handleSearch() {
            const id = document.getElementById('filter-id').value;
            const email = document.getElementById('filter-email').value;
            const anio = document.getElementById('filter-anio').value;
            const p = new URLSearchParams();
            if(id) p.append('id', id);
            if(email) p.append('usuario_email', email);
            if(anio) p.append('anio', anio);
            fetchConsultaCalificaciones(`?${p.toString()}`);
        }

        // VISTA LOGS
        async function fetchLogs() {
            try {
                const res = await fetch(`${API_BASE}/logs/`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                document.getElementById('logs-tbody').innerHTML = (data.results||data).map(l => 
                    `<tr><td>${new Date(l.fecha).toLocaleString()}</td><td>${l.accion}</td><td>${l.usuario||'Sistema'}</td><td>${l.detalle}</td></tr>`
                ).join('');
            } catch(e) {}
        }

        // MODALES DE REPORTES
        function showReportModal(tipo) {
            if(tipo === 'consolidado') showModal('modal-reporte-consolidado');
            if(tipo === 'especifico') showModal('modal-reporte-especifico');
        }

        async function loadReportDropdowns() {
            await populateSelect('/mercados/', 'reporte-mercado', 'nombre');
            await populateSelect('/estados/', 'reporte-estado', 'nombre');
            await populateUsuarios();
            await populateCalificaciones();
        }

        async function populateSelect(endpoint, id, field) {
            try {
                const res = await fetch(`${API_BASE}${endpoint}`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                const sel = document.getElementById(id);
                sel.innerHTML = '<option value="">Todos/Cualquiera</option>';
                (data.results || data).forEach(i => {
                    const opt = document.createElement('option');
                    opt.value = i.id;
                    opt.textContent = i[field];
                    sel.appendChild(opt);
                });
            } catch(e) {}
        }

        async function populateUsuarios() {
            try {
                const res = await fetch(`${API_BASE}/users/by_role/`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                const sel = document.getElementById('reporte-usuario');
                sel.innerHTML = '<option value="">Todos</option>';
                const add = (users, role) => users.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u.id;
                    opt.textContent = `${u.email} (${role})`;
                    sel.appendChild(opt);
                });
                add(data.corredores, 'Corredor');
                add(data.administradores, 'Admin');
            } catch(e) {}
        }

        async function populateCalificaciones() {
            try {
                const res = await fetch(`${API_BASE}/calificaciones/`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                const sel = document.getElementById('reporte-calificacion');
                sel.innerHTML = '<option value="">Seleccione...</option>';
                (data.results||data).forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = `ID ${c.id} - ${c.instrumento.nombre} (${c.monto_factor})`;
                    sel.appendChild(opt);
                });
            } catch(e) {}
        }

        // DESCARGAS REALES
        async function generateConsolidatedReport() {
            const p = new URLSearchParams();
            const merc = document.getElementById('reporte-mercado').value;
            const est = document.getElementById('reporte-estado').value;
            const usr = document.getElementById('reporte-usuario').value;
            if(merc) p.append('mercado_id', merc);
            if(est) p.append('estado_id', est);
            if(usr) p.append('usuario_id', usr);
            
            closeModal('modal-reporte-consolidado');
            await triggerDescarga(p, "reporte_consolidado.xlsx");
        }

        async function generateSpecificReport() {
            const id = document.getElementById('reporte-calificacion').value;
            if(!id) return alert("Seleccione una calificación");
            const p = new URLSearchParams();
            p.append('id', id);
            
            closeModal('modal-reporte-especifico');
            await triggerDescarga(p, `reporte_calificacion_${id}.xlsx`);
        }

        async function triggerDescarga(params, filename) {
            alert("Generando reporte...");
            try {
                const res = await fetch(`${API_BASE}/calificaciones/exportar_csv/?${params}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if(res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = filename;
                    a.click();
                } else alert("No hay datos o hubo un error.");
            } catch(e) { alert("Error de conexión."); }
        }
    </script>
</body>
</html>